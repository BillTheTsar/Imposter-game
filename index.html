<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Uni Imposter â€” Realtime (claims + hidden roles + zoom)</title>
<style>
  :root{--bg:#0f1320;--card:#171b2b;--ink:#e7ecff;--muted:#a9b0c8;--accent:#8aa0ff}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:980px;margin:0 auto;padding:24px}
  .h1{font-size:clamp(22px,2.6vw,32px);font-weight:800;margin:6px 0 18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1 1 320px;min-width:280px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input[type="text"], textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1220;color:var(--ink)}
  .names{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1)}
  .chip input{border:none;background:transparent;color:var(--ink);width:120px;outline:none}
  .chip button{background:none;border:none;color:#b9c0d6;cursor:pointer;font-size:16px}
  .btn{appearance:none;border:none;cursor:pointer;padding:12px 16px;border-radius:12px;font-weight:700}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#4669ff);color:white}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--ink)}
  .qbox{padding:16px;background:#0e1427;border:1px solid rgba(255,255,255,.1);border-radius:12px}
  .small{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#0e1427;border:1px solid rgba(255,255,255,.1)}
  .list{display:flex;gap:8px;flex-wrap:wrap}
  /* Zoom overlay */
  .fullzoom{position:fixed;inset:0;background:rgba(10,12,24,.98);display:none;align-items:center;justify-content:center;z-index:9999;padding:5vw}
  .fullzoom.show{display:flex}
  .fullzoom .bubble{width:100%;max-width:1100px}
  .fullzoom textarea{width:100%;height:70vh;font-size:clamp(24px,3.2vw,40px);border-radius:16px;background:#0c0f1a;color:var(--ink);border:1px solid rgba(255,255,255,.12)}
</style>
</head>
<body>
<div class="wrap" id="app"></div>
<!-- zoom overlay lives outside app so it persists across renders -->
<div class="fullzoom" id="zoomOverlay" aria-modal="true" role="dialog">
  <div class="bubble">
    <textarea id="zoomText" class="textarea" readonly></textarea>
    <div class="small mt8">Tap anywhere to close.</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// --- Firebase config (yours) ---
const firebaseConfig = {
  apiKey: "AIzaSyBbx__Iil3-FlOoLEb8VL2yEscafoXvpfg",
  authDomain: "imposter-question-game-6dccc.firebaseapp.com",
  projectId: "imposter-question-game-6dccc",
  storageBucket: "imposter-question-game-6dccc.appspot.com",
  messagingSenderId: "73958706315",
  appId: "1:73958706315:web:79d5e0cae73788bf26188e",
  measurementId: "G-5ECYXP4MPH"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);

// ===== Questions (single pool) =====
const QUESTION_POOL = [
  "A lecturer posts slides with blatant mistakes. Who do you think of?",
  "You desperately need to borrow a hundred pounds. Who do you ask?",
  "Who would you do a business case study group project with?",
  "Who is most likely to be caught using ChatGPT for an assignment?",
  "Your research requires a certain scientific claim to be true. Who is most likely to create fake data to support it?",
  "Whose name is definitely getting mispronounced in graduation?",
  "Who would push for a field trip to the British Museum?",
  "Who has an iconic catchphrase?",
  "Who is most likely to have a crush on a lecturer?",
  "You find an exam paper in a public printer. Who do you contact first?",
  "Whose life do you want to experience for a day?",
  "Who can you imagine being a millionaire lawyer in 10 years?",
  "Who is most likely to be turned on by continuous coughing and sneezing in a big lecture?",
  "Who gives 'I do hard set theory in my free time' energy?",
  "Who claims to hate group projects but still does all the work anyway even when no one asked them to?",
  "Who would you discuss 'Do you believe in the axiom of choice' with?",
  "Who has already had a villain arc in their life?",
  "Who would be the main character in a department scandal?",
  "Who secretly enjoys 9 am lectures?",
  "Who most likely has a definitely NSFW shrine in their room?",
  "Who would pay to print black and white lecture notes in full color 'just in case' there is color somewhere?",
  "Who treats LaTeX like a personality trait?",
  "Who is already 'emotionally retired' from academia?",
  "You walk out from an exam you just bombed. Who do you talk to first?",
  "Who would start a Measure Theory podcast that no one asked for?",
  "Who would write a strongly-worded SU motion about exam hall temperatures?",
  "Who has a secret and constantly updated spreadsheet ranking all the lecturers?",
  "Who secretly worships Boehning and Bjorn and is waiting for the day they become mainstream?",
  "Who would pretend to be fully interested and paying attention in a dead conversation?",
  "Who is personally and visibly offended when someone criticizes their proof?",
  "Who would fake a timetable clash to avoid group work?",
  "Who is most likely to romanticise 'suffering for the beauty of mathematics'?",
  "Who would say 'itâ€™s actually trivial' and then cannot prove it?",
  "Who saves office hours in their calendars with alarms?",
  "Who races to say 'thank you' first to a lecturer at the end of a Zoom call?",
  "Who makes you feel much smarter than you actually are?",
  "Who flips back to Y1 Analysis whenever a lecturer says 'by the FTC'?"
  "Who would visibly forget the hypothesis mid-proof?",
  "Who would ask 'Questions?' out of politeness even though they know nobody understood anything?",
  "Who would offer life advice they absolutely do not follow themselves?",
  "Who is always 'five minutes away' no matter where they are?",
  "Who would get in a relationship, break up, and let nobody know anything happened?",
  "Who would unironically say 'I don't do drama' while being the source of it?",
  "Who would go to therapy one time and declare spiritual enlightenment?",
  "Who would join a club just to see what the vibe is and then run for president?",
  "Who would you trust to see your photos album?",
  "Who would make plans they already know they can't follow through?",
  "Who would shoplift because they forgot they were holding something?",
  "Who has a mysterious source of money nobody knows about?",
  "You are emotionally wrecked. Who would you not talk to?",
  "Who would send a paragraph-long happy birthday message in a group chat?",
  "Who would thrive in a monastery and return cleansed?",
  "Who has perfected the art of ghosting and acting as if nothing happened?",
  "Who would rebrand their entire personality after one lecture they attended?",
  "Who would reply 'haha yeah' to a heartfelt message?",
  "Who would romanticize walking in the rain and be sick for two weeks?",
  "Who would look better if only they changed their hairstyle?",
  "Who would do a dramatic exit and return because they forgot something?",
  "Who would laugh during a funeral?",
  "Who would lie down in the middle of campus if life became even slightly inconvenient?",
  "Who would fall in love with someone who gave them a pen once?",
  "Who would say 'Iâ€™m over it' while building a shrine in their Notes app?",
  "Who would say 'I'll be mysterious' and then overshare immediately?",
  "Who acts like they're in a movie when they listen to music?",
  "Who has the emotional range of a Victorian poet in winter?",
  "Who would retell a story in a way that makes them sound like a legend?",
  "Who would fall in love with the barista because of 'vibe resonance'?",
  "Who uses their phone background to reflect character development?",
  
];

// ===== Utils =====
const $ = (s,r=document)=>r.querySelector(s);
const params = new URLSearchParams(location.search);
const roomParam = params.get('room') || '';
const escapeHtml = s=>String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const randomId = (n=10)=> Array.from(crypto.getRandomValues(new Uint8Array(n))).map(b=>"ABCDEFGHJKMNPQRSTUVWXYZ23456789"[b%32]).join('');
const fnv1a = s=>{let h=0x811c9dc5>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}return h>>>0;};
const xs32 = seed=>{let x=seed>>>0;return()=>{x^=x<<13;x>>>=0;x^=x>>>17;x>>>=0;x^=x<<5;x>>>=0;return x>>>0;};};
const nextIndex=(rng,n)=> rng()%n;

// ===== Presence/claims =====
const CLIENT_ID_KEY = 'imposter:clientId';
let clientId = localStorage.getItem(CLIENT_ID_KEY);
if(!clientId){ clientId = 'C-' + randomId(8); localStorage.setItem(CLIENT_ID_KEY, clientId); }

render();

function addNameChip(val=""){
  const names = $('#names');
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.innerHTML = `<input type="text" placeholder="Player name" value="${escapeHtml(val)}" />
                    <button title="Remove" aria-label="Remove">Ã—</button>`;
  chip.querySelector('button').onclick = ()=> chip.remove();
  names.appendChild(chip);
}

function hostView(){
  const root = $('#app');
  root.innerHTML = `
    <div class="h1">ðŸŽ­ Uni Imposter â€” Realtime (host)</div>
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Room code</label>
          <input id="roomCode" type="text" placeholder="e.g. WARW-2025" />

          <label class="mt16">Players (enter names)</label>
          <div id="names" class="names"></div>
          <button class="btn ghost mt8" id="addPlayer">+ Add player</button>

          <div class="mt16">
            <button class="btn primary" id="saveRoom">Create/Update room</button>
            <button class="btn ghost" id="startRound">Start round</button>
            <button class="btn ghost" id="nextRound">Play again (new round)</button>
          </div>
        </div>
        <div class="col">
          <label>Current state</label>
          <div id="state" class="qbox small">No room yet.</div>
          <label class="mt12">Joined (live)</label>
          <div id="joined" class="qbox small">â€”</div>
          <div class="small mt8">Host never sees questions or roles. A name can only be claimed by one device.</div>
        </div>
      </div>
    </div>`;
  for(let i=0;i<8;i++) addNameChip();
  $('#addPlayer').onclick=()=>addNameChip();
  $('#saveRoom').onclick=saveRoom;
  $('#startRound').onclick=startRound;
  $('#nextRound').onclick=startRound;
}

async function saveRoom(){
  const room = $('#roomCode').value.trim(); if(!room) return alert('Enter a room code');
  const names = Array.from($('#names').querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
  if(names.length<3) return alert('Add at least 3 names');
  const ref = doc(db,'rooms',room);
  await setDoc(ref, { createdAt: serverTimestamp(), players:names, round:0, seed: randomId(), impIndex: Math.floor(Math.random()*names.length), claims: {} }, {merge:true});
  $('#state').innerHTML = `<div>Room: <b>${escapeHtml(room)}</b></div><div>Players: ${names.map(n=>`<span class='chip'>${escapeHtml(n)}</span>`).join(' ')}</div><div class='small'>Share: ${location.origin+location.pathname}?room=${encodeURIComponent(room)}</div>`;
  onSnapshot(ref, (snap)=>{
    const data = snap.data()||{}; const claims = data.claims||{}; const namesArr = data.players||[];
    const claimed = new Set(Object.values(claims).map(c=>c.name));
    const html = namesArr.map(n=>`<span class='pill'>${escapeHtml(n)} ${claimed.has(n)?'â€¢ joined':''}</span>`).join(' ');
    $('#joined').innerHTML = html || 'â€”';
  });
  alert('Room saved. Share the link above.');
}

async function startRound(){
  const room = $('#roomCode').value.trim(); if(!room) return alert('Enter a room code');
  const ref = doc(db,'rooms',room); const snap = await getDoc(ref); if(!snap.exists()) return alert('Save room first');
  const data = snap.data(); const names = data.players||[]; await updateDoc(ref, { round:(data.round||0)+1, seed: randomId(), impIndex: Math.floor(Math.random()*names.length) });
}

function playerView(room){
  const root = $('#app');
  root.innerHTML = `
    <div class="h1">ðŸŽ­ Uni Imposter â€” Player</div>
    <div class="card">
      <div class="row" style="align-items:center;justify-content:space-between;">
        <div class="pill">Room: <b>${escapeHtml(room)}</b></div>
        <div class="pill">Status: <span id="status">Connectingâ€¦</span></div>
      </div>
      <label class="mt16">Choose your name</label>
      <div id="nameChoices" class="list"></div>
      <div class="small mt8">Only unclaimed names are clickable. If you disconnect, your device will reclaim your name when you return.</div>
      <label class="mt16">Your prompt</label>
      <div id="prompt" class="qbox">â€”</div>
      <label class="mt16">Your answer</label>
      <textarea id="answer" class="textarea" placeholder="Type a short answer"></textarea>
      <div class="mt8"><button class="btn primary" id="zoomOpen">ðŸ”Ž Zoom</button></div>
    </div>`;

  // --- Zoom wiring (must be AFTER render) ---
  const zoomBtn = $('#zoomOpen');
  const zoomOverlay = $('#zoomOverlay');
  const zoomText = $('#zoomText');
  zoomBtn.onclick = () => {
    const a = $('#answer');
    zoomText.value = a ? a.value : '';
    zoomOverlay.classList.add('show');
    document.body.style.overflow = 'hidden';
  };
  zoomOverlay.onclick = () => {
    zoomOverlay.classList.remove('show');
    document.body.style.overflow = '';
  };

  const ref = doc(db,'rooms',room);
  onSnapshot(ref, async (snap)=>{
    if(!snap.exists()){ $('#status').textContent='Room not found'; return; }
    const data = snap.data();
    const names = data.players||[]; const round = data.round||0; const seed = data.seed||''; const impIndex = data.impIndex ?? -1; const claims = data.claims||{};

    // Build name choice UI with claim locking
    const claimedBy = {}; Object.entries(claims).forEach(([cid,val])=>{ if(val && val.name) claimedBy[val.name]=cid; });
    const myClaim = claims[clientId];
    const container = $('#nameChoices');
    if(!container.dataset.rendered || container.dataset.rendered!==JSON.stringify(claims)){
      container.innerHTML = names.map((n)=>{
        const locked = claimedBy[n] && claimedBy[n]!==clientId;
        return `<button class="btn ${locked?'ghost':'primary'}" data-name="${escapeHtml(n)}" ${locked?'disabled':''}>${escapeHtml(n)}${locked?' (taken)':''}</button>`;
      }).join(' ');
      container.dataset.rendered = JSON.stringify(claims);
      container.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=>{
          const chosen = btn.getAttribute('data-name');
          await updateDoc(ref, { [`claims.${clientId}`]: { name: chosen, at: serverTimestamp() } });
        };
      });
    }

    // If we have a claim, compute prompt
    const myName = (myClaim && myClaim.name) ? myClaim.name : null;
    if(!myName){ $('#status').textContent = 'Pick your name'; $('#prompt').textContent='â€”'; return; }
    const yourIndex = Math.max(0, names.findIndex(x=>x.toLowerCase()===myName.toLowerCase()));
    $('#status').textContent = `You are: ${escapeHtml(myName)} â€¢ ${round>0?('Round '+round):'waiting for host'}`;

    if(round<=0){ $('#prompt').textContent='Waiting for hostâ€¦'; return; }

    // Generate a deterministic shuffle for the room itself (does NOT change every round)
    const roomBase = fnv1a(room);
    const roomRng = xs32(roomBase);
    const shuffled = QUESTION_POOL.slice().sort(() => (roomRng() % 2 ? 1 : -1));

    // Now round randomness picks positions in the *shuffled* deck
    const base = fnv1a(room + '|' + seed);
    const rng = xs32(base);
    const n = shuffled.length;
    const isImposter = (yourIndex === impIndex);

    const commonIdx = nextIndex(rng, n);
    let impostorIdx = commonIdx;
    while(impostorIdx === commonIdx) impostorIdx = nextIndex(rng, n);
    $('#prompt').textContent = shuffled[ isImposter ? impostorIdx : commonIdx ] || 'â€”';

    // persist answer per round per client
    const key = `ans:${room}:${clientId}:${round}`; const ans = $('#answer'); ans.value = localStorage.getItem(key)||''; ans.oninput=()=>localStorage.setItem(key, ans.value);
  });
}

function render(){
  if(!roomParam) hostView(); else playerView(roomParam);
}
</script>
</body>
</html>
